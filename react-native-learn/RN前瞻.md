# RN前瞻，庖丁解牛！深入剖析React Native下一代架构重构

[TOC]

## 从业务实际开发中还是遇到了不少坑，其中性能问题比较明显，具体有以下几类问题：

- 加载性能偏慢，因为系统或者自定义的原生 UI 组件和 API 的注册**加载过程中需要验证所有属性和 JS API 的一致性，影响加载性能，甚至直接导致主 UI 线程很容易阻塞**。

- JSBridge，**React Native 整体生命周期和 JSBridge 绑定太紧**，所有的原生和 JS 之间操作全部是通过这个 Bridge，而且每次的事件通讯是有时间间隔的，**导致整体渲染过程是异步的**。

- **手势问题**，React Native 目前的架构，从 JS 侧很难解决很多复杂的手势问题，需要重新定制 SDK 来解决问题。

- **返回事件的处理**，目前的返回事件不能像原生一样，在组件中监听。

- Layout 的计算，整体的 UI 计算必须要在 **shadow layout** 中完成，没有办法在整体的平台框架中计算。

### 问题总结

目前的架构下这些组件和 API 太过依赖 JSBridge 的初始化，而且通讯能力也局限于这一条通道。从渲染的层次来看，React Native 是多线程运行的，最常见的是 JS 线程和原生端的线程，一旦线程间异常，JSBridge 整体将会阻塞，我们经常也能看到 JS 运行异常了，实际 JS 线程已经无响应了，但原生端还能响应滚动事件。

## 官方建议的一些优化性能的方案：

1. 组件的懒加载注册，原生端可以采用懒注册，在业务**使用到该组件时注册**。

2. 按需打包，直接减少业务包大小，**去掉一些不需要的 module，提高渲染速度**。

3. **业务的懒加载**，直接减少业务渲染过程中 require 各个组件的时间。

4. UNBundle，将业务分解成**小的模块，提供性能**。

5. **移走初始化过程中不必要的 JS module 模块**。

6. 提供 prepack 工具优化 JS 代码。